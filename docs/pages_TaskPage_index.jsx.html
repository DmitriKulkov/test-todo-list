<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages/TaskPage/index.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pages/TaskPage/index.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useContext, useState, useEffect } from "react";
import {
  deleteDoc,
  doc,
  getDoc,
  setDoc,
  updateDoc,
} from "firebase/firestore/lite";
import useFetching from "../../hooks/useFetching";
import { Context } from "../..";
import { Link, useNavigate, useParams } from "react-router-dom";
import dayjs from "dayjs";
import classes from "./index.module.less";
import EditDialog from "../../components/UI/EditDialog";
import TaskForm from "../../components/TaskForm";
import {
  deleteObject,
  getDownloadURL,
  listAll,
  ref,
  uploadBytes,
} from "firebase/storage";
import FormButton from "../../components/UI/FormButton";
import Status from "../../components/Status";
import ConfirmBox from "../../components/UI/ConfirmBox";
import Loader from "../../components/UI/Loader";
/**
 * Specific task page
 * @returns {React.FC}
 */
const TaskPage = () => {
  /**
   * @typedef {Object} Task
   * @property {string} title
   * @property {string} description
   * @property {string} endsAt
   * @property {string} status
   */

  const [task, setTask] = useState();
  const [editOpen, setEditOpen] = useState(false);
  const [files, setFiles] = useState({});
  const [urls, setUrls] = useState({});
  const [deleteBoxOpen, setDeleteBoxOpen] = useState(false);

  const { id } = useParams();

  const navigate = useNavigate();

  const { firestore, storage } = useContext(Context);

  const { fetching, loading, error } = useFetching(() => {
    return Promise.all([
      getDoc(doc(firestore, "tasks", id)).then((res) => {
        if (res.exists()) {
          setTask({ ...res.data(), id: id });
        }
      }),
      getFilesAndUrls().then(([files, urls]) => {
        setFiles(files);
        setUrls(urls);
      }),
    ]);
  });

  /**
   * Get files and urls for download
   * @returns {Promise&lt;Object[]>}
   */
  const getFilesAndUrls = async () => {
    const files = await getFilesList();
    const urls = await getUrls(files);
    return [files, urls];
  };

  useEffect(() => {
    fetching();
  }, [fetching]);

  /**
   * Task edit handler
   * @param {Task} editedTask
   * @returns {Promise&lt;void>}
   */
  const handleEdit = async (editedTask) => {
    await setDoc(doc(firestore, "tasks", id), editedTask);
  };
  /**
   * File upload handler
   * @param {string} filename
   * @param {File} file
   * @returns {Promise}
   */
  const handleUploadFile = (filename, file) => {
    return uploadBytes(ref(storage, task.id + "/" + filename), file);
  };
  /**
   * File delete handler
   * @param {string} filename
   * @returns {Promise&lt;void>}
   */
  const deleteFile = (filename) => {
    return deleteObject(ref(storage, id + "/" + filename));
  };
  /**
   * Task files upload &amp; deletion handler
   * @param {Object} newFiles
   * @returns {Promise&lt;any[]>}
   */
  const handleFiles = (newFiles) => {
    const promises = [];
    Object.entries(files).forEach(([filename, todelete]) => {
      if (todelete) {
        promises.push(deleteFile(filename));
      }
    });
    Object.entries(newFiles).forEach(([filename, file]) => {
      promises.push(handleUploadFile(filename, file));
    });
    return Promise.all(promises);
  };
  /**
   * Task deletion handler
   * @returns {Promise&lt;any[]>}
   */
  const handleDelete = () => {
    console.log("hi");
    navigate("/");
    return Promise.all(
      [deleteDoc(doc(firestore, "tasks", id))],
      Object.entries(files).forEach((file) => deleteFile(file[0]))
    );
  };

  const getFilesList = async () => {
    const files = await listAll(ref(storage, id));
    const filenames = files.items.map((doc) =>
      doc._location.path_.split("/").at(-1)
    );
    const dict = {};
    filenames.forEach((file) => {
      dict[file] = false;
    });
    return dict;
  };

  /**
   * Get URL for file download
   * @param {Object} files
   * @returns {Promise&lt;Object>}
   */
  const getUrls = async (files) => {
    const promises = [];
    const urls = {};
    for (const file of Object.entries(files)) {
      promises.push(
        getDownloadURL(ref(storage, id + "/" + file[0])).then((url) => {
          urls[file[0]] = url;
        })
      );
    }
    await Promise.all(promises);
    return urls;
  };
  /**
   * Returns urls components list
   * @returns {any[]}
   */
  const viewUrls = () => {
    const res = [];
    Object.entries(urls).forEach(([filename, url]) => {
      res.push(
        &lt;a href={url} key={filename}>
          &lt;p>{filename}&lt;/p>
        &lt;/a>
      );
    });
    return res;
  };

  return (
    &lt;div>
      {loading ? (
        &lt;div className={classes.loader}>
          &lt;Loader />
        &lt;/div>
      ) : (
        &lt;div>
          {task ? (
            &lt;div className={classes.taskpage}>
              &lt;Link to="/">
                &lt;FormButton className={classes.back_button}>
                  {"&lt; Back"}
                &lt;/FormButton>
              &lt;/Link>
              &lt;FormButton
                className={classes.edit_button}
                onClick={() => setEditOpen(true)}
              >
                Edit
              &lt;/FormButton>
              &lt;EditDialog open={editOpen} setOpen={setEditOpen}>
                &lt;TaskForm
                  onSubmit={async (task, newFiles) => {
                    await Promise.all([
                      handleEdit(task),
                      handleFiles(newFiles),
                    ]);
                    fetching();
                    setEditOpen(false);
                  }}
                  setOpen={setEditOpen}
                  task={task}
                  files={files}
                  setFiles={setFiles}
                />
              &lt;/EditDialog>
              &lt;h1 className={classes.text_wrap}>{task.title}&lt;/h1>
              &lt;div>
                {task.status === "Done" ? (
                  &lt;Status status={"Done"} />
                ) : dayjs(task.endsAt).isBefore(dayjs(), "day") ? (
                  &lt;Status status={"Expired"} />
                ) : (
                  &lt;Status status={"In progress"} />
                )}
              &lt;/div>
              &lt;p>{dayjs(task.endsAt).format("D MMM YYYY")}&lt;/p>
              &lt;h3>Description&lt;/h3>
              &lt;p className={classes.text_wrap}>{task.description}&lt;/p>
              {files &amp;&amp; (
                &lt;div>
                  &lt;h3>Files&lt;/h3>
                  {viewUrls()}
                &lt;/div>
              )}
              &lt;div>
                &lt;FormButton
                  color="reject"
                  onClick={() => setDeleteBoxOpen(true)}
                >
                  Delete
                &lt;/FormButton>
                &lt;ConfirmBox
                  open={deleteBoxOpen}
                  setOpen={setDeleteBoxOpen}
                  message="Are you shure you want to delete this task?"
                  reject="Cancel"
                  onReject={() => setDeleteBoxOpen(false)}
                  confirm="Delete"
                  onConfirm={handleDelete}
                />
                {task.status === "In progress" ? (
                  &lt;FormButton
                    onClick={() => {
                      setTask((prev) => {
                        return { ...prev, status: "Done" };
                      });
                      updateDoc(doc(firestore, "tasks", id), {
                        status: "Done",
                      });
                    }}
                  >
                    Mark as Done
                  &lt;/FormButton>
                ) : (
                  &lt;FormButton
                    onClick={() => {
                      setTask((prev) => {
                        return { ...prev, status: "In progress" };
                      });
                      updateDoc(doc(firestore, "tasks", id), {
                        status: "In progress",
                      });
                    }}
                  >
                    Mark as In progress
                  &lt;/FormButton>
                )}
              &lt;/div>
            &lt;/div>
          ) : (
            &lt;div>Error&lt;/div>
          )}
        &lt;/div>
      )}
    &lt;/div>
  );
};

export default TaskPage;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#App">App</a></li><li><a href="global.html#AppRoutes">AppRoutes</a></li><li><a href="global.html#ConfirmBox">ConfirmBox</a></li><li><a href="global.html#Context">Context</a></li><li><a href="global.html#EditDialog">EditDialog</a></li><li><a href="global.html#FilesList">FilesList</a></li><li><a href="global.html#FormButton">FormButton</a></li><li><a href="global.html#Loader">Loader</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#TaskForm">TaskForm</a></li><li><a href="global.html#TaskList">TaskList</a></li><li><a href="global.html#TaskListPage">TaskListPage</a></li><li><a href="global.html#TaskPage">TaskPage</a></li><li><a href="global.html#firebaseConfig">firebaseConfig</a></li><li><a href="global.html#root">root</a></li><li><a href="global.html#useFetching">useFetching</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Mon Nov 28 2022 19:47:00 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
